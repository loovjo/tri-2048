<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <title>Tri-2048</title>
        <style>
.move {
    padding: 32px 20px;
    text-align: center;
    display: inline-block;
    border: none;
    background: #BBBBBB;
}

        </style>
    </head>
    <body>
        <canvas id="2048_canvas"></canvas>
        <br/>
        <button class="move" onclick="result.instance.exports.merge_dir(0)">↖️</button>
        <button class="move" onclick="result.instance.exports.merge_dir(1)">↗️</button>
        <br/>
        <button class="move" onclick="result.instance.exports.merge_dir(2)">⬅️</button>
        <button class="move" onclick="result.instance.exports.merge_dir(3)">➡️</button>
        <br/>
        <button class="move" onclick="result.instance.exports.merge_dir(4)">↙️</button>
        <button class="move" onclick="result.instance.exports.merge_dir(5)">↘️</button>
    </body>
    <script>
        var squaresize = 60;

        var game_width, game_height;

        var canvas = document.getElementById("2048_canvas");
        var ctx = canvas.getContext("2d");

        var LOG_BUF = "";

        var result;

        fetch("tri_2048.wasm")
            .then(response => response.arrayBuffer())
            .then(bytes => WebAssembly.instantiate(bytes, {
                env: {
                    u_log: ch => {
                        if (ch == 10) {
                            console.log(LOG_BUF);
                            LOG_BUF = "";
                        }
                        else {
                            LOG_BUF += String.fromCharCode(ch);
                        }
                    },
                    u_set_size: (width_, height_) => {
                        window.game_width = width_;
                        window.game_height = height_;
                        canvas.width = squaresize * (width_ + 1);
                        canvas.height = squaresize * (height_ + 1);
                        ctx.font = "20px helvetica";
                        ctx.textAlign = "center";
                        console.log(width_, height_);
                    },
                    u_set: (num, y, x) => {

                        let poly_size = squaresize / 2;

                        let x_pos = (x + y / 2);
                        let y_pos = (game_width - y - 1) * Math.sqrt(3) / 2;

                        let x_px = x_pos * squaresize + poly_size;
                        let y_px = y_pos * squaresize + poly_size;

                        ctx.beginPath();
                        ctx.fillStyle = '#BBFFBB';
                        ctx.drawStyle = '#000000';
                        // draw polygon
                        ctx.moveTo(x_px, y_px + poly_size);
                        for (i = 0; i < 6; i++) {
                            angle = i * Math.PI / 3;
                            ctx.lineTo(x_px + poly_size * Math.sin(angle), y_px + poly_size * Math.cos(angle));
                        }
                        ctx.closePath();
                        ctx.stroke();
                        ctx.fill();

                        ctx.fillStyle = '#000';

                        if (num != 0) {
                            text = 1 << num;
                            ctx.fillText(text, x_px, y_px);
                        }
                    },
                    u_clear: () => {
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                    },
                    u_rand: () => { return Math.random() }
                }
            }))
            .then(result_ => {
                result = result_;
                result.instance.exports.start();

                document.body.addEventListener("keydown", event => {
                    result.instance.exports.key_down(event.keyCode);
                });
            })
    </script>
</html>