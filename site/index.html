<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <title>Tri-2048</title>
        <style>
.move {
    padding: 32px 20px;
    text-align: center;
    display: inline-block;
    border: none;
    background: #BBBBBB;
}
        </style>
    </head>
    <body>
        <canvas id="2048_canvas"></canvas>
        <br/>
        <button class="move" onclick="result.instance.exports.merge_dir(0)">↖️</button>
        <button class="move" onclick="result.instance.exports.merge_dir(1)">↗️</button>
        <br/>
        <button class="move" onclick="result.instance.exports.merge_dir(2)">⬅️</button>
        <button class="move" onclick="result.instance.exports.merge_dir(3)">➡️</button>
        <br/>
        <button class="move" onclick="result.instance.exports.merge_dir(4)">↙️</button>
        <button class="move" onclick="result.instance.exports.merge_dir(5)">↘️</button>
    </body>
    <script>
        var squaresize_x = 15;
        var squaresize_y = 20;

        var canvas = document.getElementById("2048_canvas");
        var ctx = canvas.getContext("2d");

        canvas.width = squaresize_x * 20;
        canvas.height = squaresize_y * 20;
        ctx.textAlign = "center";
        ctx.font = (squaresize_y * 0.8 | 0) + "px monospace";

        var LOG_BUF = "";

        var result;

        fetch("tri_2048.wasm")
            .then(response => response.arrayBuffer())
            .then(bytes => WebAssembly.instantiate(bytes, {
                env: {
                    u_log: ch => {
                        if (ch == 10) {
                            console.log(LOG_BUF);
                            LOG_BUF = "";
                        }
                        else {
                            LOG_BUF += String.fromCharCode(ch);
                        }
                    },
                    u_set: (num, y, x) => {
                        if (num == 0) {
                            text = ".";
                        } else {
                            text = 1 << num;
                        }
                        ctx.fillText(text, (x * 3 + 1) * squaresize_x, (y * 3 + 1) * squaresize_y);
                    },
                    u_clear: () => {
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                    },
                    u_rand: () => { return Math.random() }
                }
            }))
            .then(result_ => {
                result = result_;
                result.instance.exports.start();

                document.body.addEventListener("keydown", event => {
                    <!-- console.log(event); -->
                    result.instance.exports.key_down(event.keyCode);
                });
            })
    </script>
</html>